<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dexter Projects LK - Invoice Management</title>
    <style>
        :root {
            --primary-color: #0d0d0d;
            --secondary-color: #1a1a1a;
            --accent-color: #4a6fa5;
            --text-color: #e0e0e0;
            --border-color: #333;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --nav-color: #ffffff;
            --card-bg: #2a2a2a;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--primary-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .dashboard-banner {
            width: 100%;
            height: 150px;
            background-color: var(--secondary-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .dashboard-banner img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .nav-tabs {
            display: flex;
            background-color: var(--nav-color);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: #333;
        }
        
        .nav-tab img {
            height: 32px;
            width: auto;
        }
        
        .nav-tab.active {
            background-color: var(--accent-color);
            color: white;
        }
        
        .tab-content {
            display: none;
            background-color: var(--secondary-color);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            align-items: flex-start;
        }
        
        .letterhead {
            width: 100%;
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .letterhead img {
            width: 100%;
            height: auto;
            border-radius: 12px;
        }
        
        .invoice-details {
            text-align: right;
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px;
            background-color: var(--primary-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            color: var(--text-color);
            transition: all 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.3);
        }
        
        .autocomplete {
            position: relative;
        }
        
        .autocomplete-items {
            position: absolute;
            border: 1px solid var(--border-color);
            border-top: none;
            z-index: 10000;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--primary-color);
            max-height: 200px;
            overflow-y: auto;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        
        .autocomplete-item:hover {
            background-color: var(--secondary-color);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background-color: rgba(0,0,0,0.3);
            font-weight: 500;
        }
        
        .invoice-total {
            text-align: right;
            font-size: 1.2rem;
            font-weight: 500;
            margin-top: 20px;
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .invoice-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #3a5f95;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-secondary {
            background-color: #666;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #555;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        .inventory-actions {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        
        .profit-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .profit-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .profit-card h3 {
            margin-bottom: 10px;
            color: var(--accent-color);
        }
        
        .profit-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--success-color);
        }
        
        .payment-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .paid {
            background-color: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }
        
        .pending {
            background-color: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: var(--secondary-color);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-modal {
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .save-animation {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--success-color);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            z-index: 2000;
            animation: fadeOut 0.5s ease-in-out 0.5s forwards;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; display: none; }
        }
        
        .payment-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .payment-card {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .payment-card h4 {
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: #aaa;
        }
        
        .payment-amount {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .received {
            color: var(--success-color);
        }
        
        .pending {
            color: #ffc107;
        }
        
        .payment-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }
        
        .payment-input {
            flex: 1;
        }
        
        .full-payment {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }
        
        .project-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .save-payment-btn {
            margin-top: 10px;
        }
        
        .project-row {
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .project-row:hover {
            background-color: rgba(255,255,255,0.05);
        }
        
        /* Calendar Styles */
        .calendar {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .calendar-day {
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            background-color: var(--primary-color);
            min-height: 80px;
            display: flex;
            flex-direction: column;
            border: 2px solid transparent;
        }
        
        .calendar-day-header {
            font-weight: bold;
            padding: 10px;
            text-align: center;
            background-color: var(--accent-color);
            border-radius: 8px;
        }
        
        .calendar-day.other-month {
            opacity: 0.5;
        }
        
        .calendar-day.today {
            border-color: var(--success-color);
        }
        
        .calendar-day.urgent-deadline {
            border-color: var(--danger-color);
        }
        
        .calendar-day.normal-deadline {
            border-color: #ffc107;
        }
        
        .deadline-item {
            background-color: var(--accent-color);
            color: white;
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-top: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            #invoice-preview, #invoice-preview * {
                visibility: visible;
            }
            #invoice-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
        
        /* Inline Suggestion Styles */
        .inline-suggestion {
            position: absolute;
            pointer-events: none;
            color: #888;
            z-index: 1;
            padding: 10px;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            border: 1px solid transparent;
            border-radius: 8px;
            overflow: hidden;
            white-space: nowrap;
            user-select: none;
        }
        
        .description-container {
            position: relative;
        }
        
        .description-container input {
            position: relative;
            background-color: transparent;
            z-index: 2;
        }
        
        .discount-section {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .discount-row {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .discount-input {
            flex: 1;
        }
        
        .discount-type {
            width: 150px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .summary-row.total {
            font-weight: bold;
            font-size: 1.1rem;
            border-bottom: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid var(--border-color);
        }
        
        .summary-row.discount {
            color: var(--danger-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="dashboard-banner">
            <!-- Banner image will be loaded here -->
            <img id="banner-img" src="banner.png" alt="Dexter Projects LK Banner" onerror="this.style.display='none'">
        </div>
        
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="invoice">
                <img id="invoice-tab-img" src="invoice.png" alt="Create Invoice" onerror="this.style.display='none'">
                <span>Create Invoice</span>
            </div>
            <div class="nav-tab" data-tab="inventory">
                <img id="inventory-tab-img" src="Inventory.png" alt="Manage Inventory" onerror="this.style.display='none'">
                <span>Manage Inventory</span>
            </div>
            <div class="nav-tab" data-tab="profits">
                <img id="profit-tab-img" src="profit.png" alt="View Profits" onerror="this.style.display='none'">
                <span>View Profits</span>
            </div>
            <div class="nav-tab" data-tab="calendar">
                <img id="calendar-tab-img" src="cal.png" alt="View Calendar" onerror="this.style.display='none'">
                <span>Calendar</span>
            </div>
        </div>
        
        <!-- Invoice Tab -->
        <div id="invoice" class="tab-content active">
            <div class="invoice-header">
                <div class="letterhead">
                    <!-- Letterhead image will be loaded here -->
                    <img id="letterhead-img" src="Invoice.jpg" alt="Dexter Projects LK Letterhead" onerror="this.style.display='none'">
                </div>
                <div class="invoice-details">
                    <div class="form-group">
                        <label for="invoice-date">Date</label>
                        <input type="date" id="invoice-date" value="">
                    </div>
                    <div class="form-group">
                        <label for="invoice-number">Invoice No</label>
                        <input type="text" id="invoice-number" value="" readonly>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="invoice-to">INVOICE TO:</label>
                <input type="text" id="invoice-to" placeholder="Client Name">
            </div>
            
            <div class="form-group">
                <label for="project-name">Project:</label>
                <input type="text" id="project-name" placeholder="Project Name">
            </div>
            
            <div class="form-group">
                <label for="deadline">Deadline (Optional):</label>
                <input type="date" id="deadline">
            </div>
            
            <table id="invoice-items">
                <thead>
                    <tr>
                        <th>Description</th>
                        <th width="100">Qty</th>
                        <th width="150">Price</th>
                        <th width="150">Total</th>
                        <th width="50"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <div class="description-container">
                                <input type="text" class="item-description" placeholder="Item description">
                                <div class="inline-suggestion"></div>
                            </div>
                        </td>
                        <td><input type="number" class="item-qty" min="1" value="1"></td>
                        <td><input type="number" class="item-price" readonly></td>
                        <td class="item-total">LKR 0</td>
                        <td><button class="btn-danger remove-item">×</button></td>
                    </tr>
                </tbody>
            </table>
            
            <button id="add-item" class="btn-secondary">+ Add Item</button>
            
            <!-- Discount Section -->
            <div class="discount-section">
                <h3>Special Discounts</h3>
                <div class="discount-row">
                    <div class="form-group discount-input">
                        <label for="discount-amount">Discount Amount</label>
                        <input type="number" id="discount-amount" min="0" step="0.01" placeholder="0">
                    </div>
                    <div class="form-group discount-type">
                        <label for="discount-type">Type</label>
                        <select id="discount-type">
                            <option value="fixed">Fixed Amount</option>
                            <option value="percentage">Percentage</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="discount-reason">Discount Reason (Optional)</label>
                    <input type="text" id="discount-reason" placeholder="e.g., Special offer, Bulk discount, etc.">
                </div>
            </div>
            
            <div class="form-group">
                <label for="invoice-notes">Notes:</label>
                <textarea id="invoice-notes" rows="3" placeholder="Optional notes..."></textarea>
            </div>
            
            <!-- Enhanced Invoice Total Section -->
            <div class="invoice-total">
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span id="subtotal-amount">LKR 0</span>
                </div>
                <div class="summary-row discount" id="discount-display">
                    <span>Discount:</span>
                    <span id="discount-value">LKR 0</span>
                </div>
                <div class="summary-row total">
                    <strong>Total:</strong>
                    <strong id="grand-total">LKR 0</strong>
                </div>
            </div>
            
            <div class="invoice-actions">
                <button id="preview-invoice" class="btn-primary">Preview Invoice</button>
                <button id="save-invoice" class="btn-success">Save Invoice</button>
            </div>
        </div>
        
        <!-- Inventory Tab -->
        <div id="inventory" class="tab-content">
            <div class="inventory-actions">
                <button id="add-inventory-item" class="btn-primary">Add New Item</button>
            </div>
            
            <table id="inventory-table">
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Buying Price</th>
                        <th>Selling Price</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Inventory items will be populated here -->
                </tbody>
            </table>
        </div>
        
        <!-- Profits Tab -->
        <div id="profits" class="tab-content">
            <div class="profit-filters">
                <div class="form-group">
                    <label for="profit-period">Period</label>
                    <select id="profit-period">
                        <option value="monthly">Monthly</option>
                        <option value="all-time">All Time</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="profit-month">Month</label>
                    <input type="month" id="profit-month" value="">
                </div>
            </div>
            
            <div class="payment-summary">
                <div class="payment-card">
                    <h4>Payments Received</h4>
                    <div class="payment-amount received" id="payments-received">LKR 0</div>
                </div>
                <div class="payment-card">
                    <h4>Pending Payments</h4>
                    <div class="payment-amount pending" id="pending-payments">LKR 0</div>
                </div>
            </div>
            
            <div class="profit-card">
                <h3>Overall Profit</h3>
                <div class="profit-value" id="overall-profit">LKR 0</div>
            </div>
            
            <h3>Project-wise Profits</h3>
            <table id="project-profits">
                <thead>
                    <tr>
                        <th>Project</th>
                        <th>Total Revenue</th>
                        <th>Total Cost</th>
                        <th>Profit</th>
                        <th>Advance Payment</th>
                        <th>Pending Payment</th>
                        <th>Actions</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Project profits will be populated here -->
                </tbody>
            </table>
        </div>
        
        <!-- Calendar Tab -->
        <div id="calendar" class="tab-content">
            <div class="calendar">
                <div class="calendar-header">
                    <button id="prev-month" class="btn-secondary">&lt; Prev</button>
                    <h2 id="calendar-month-year">Month Year</h2>
                    <button id="next-month" class="btn-secondary">Next &gt;</button>
                </div>
                <div class="calendar-grid" id="calendar-days">
                    <!-- Calendar will be generated here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Save Animation -->
    <div id="save-animation" class="save-animation">
        Invoice Saved Successfully!
    </div>
    
    <!-- Inventory Item Modal -->
    <div id="inventory-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Add Inventory Item</h3>
                <span class="close-modal">&times;</span>
            </div>
            <form id="inventory-form">
                <input type="hidden" id="item-id">
                <div class="form-group">
                    <label for="item-description">Description</label>
                    <input type="text" id="item-description" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="item-buying-price">Buying Price (LKR)</label>
                        <input type="number" id="item-buying-price" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="item-selling-price">Selling Price (LKR)</label>
                        <input type="number" id="item-selling-price" min="0" step="0.01" required>
                    </div>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn-primary">Save Item</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Invoice Preview Modal -->
    <div id="invoice-preview-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Invoice Preview</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div id="invoice-preview">
                <!-- Invoice preview will be generated here -->
            </div>
        </div>
    </div>

    <!-- Invoice Details Modal -->
    <div id="invoice-details-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Invoice Details</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div id="invoice-details">
                <!-- Invoice details will be generated here -->
            </div>
            <div class="invoice-actions" style="margin-top: 20px;">
                <button id="download-invoice-pdf" class="btn-primary">Download as PDF</button>
            </div>
        </div>
    </div>

    <script>
        // Data storage functions
        function saveData() {
            localStorage.setItem('inventory', JSON.stringify(inventory));
            localStorage.setItem('invoices', JSON.stringify(invoices));
        }
        
        function loadData() {
            const savedInventory = localStorage.getItem('inventory');
            const savedInvoices = localStorage.getItem('invoices');
            
            if (savedInventory) {
                inventory = JSON.parse(savedInventory);
            }
            
            if (savedInvoices) {
                invoices = JSON.parse(savedInvoices);
            }
        }
        
        // Sample inventory data
        let inventory = [
            { id: 1, description: "Node MCU Long Range WIFI", buyingPrice: 35000, sellingPrice: 42000 },
            { id: 2, description: "WIFI Range Extender Antena", buyingPrice: 3000, sellingPrice: 3900 },
            { id: 3, description: "Ice Blue Screen", buyingPrice: 30000, sellingPrice: 37000 },
            { id: 4, description: "5V Power Adapter", buyingPrice: 500, sellingPrice: 650 },
            { id: 5, description: "13A base + 13A Plug top", buyingPrice: 2000, sellingPrice: 2500 }
        ];
        
        // Invoices data - no sample project
        let invoices = [];
        
        // Calendar data
        let currentDate = new Date();
        
        // DOM Elements
        const navTabs = document.querySelectorAll('.nav-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const invoiceItemsTable = document.getElementById('invoice-items');
        const addItemBtn = document.getElementById('add-item');
        const grandTotalEl = document.getElementById('grand-total');
        const subtotalEl = document.getElementById('subtotal-amount');
        const discountValueEl = document.getElementById('discount-value');
        const discountDisplayEl = document.getElementById('discount-display');
        const inventoryTable = document.getElementById('inventory-table');
        const addInventoryItemBtn = document.getElementById('add-inventory-item');
        const inventoryModal = document.getElementById('inventory-modal');
        const closeModalBtns = document.querySelectorAll('.close-modal');
        const inventoryForm = document.getElementById('inventory-form');
        const projectProfitsTable = document.getElementById('project-profits');
        const overallProfitEl = document.getElementById('overall-profit');
        const profitPeriod = document.getElementById('profit-period');
        const profitMonth = document.getElementById('profit-month');
        const previewInvoiceBtn = document.getElementById('preview-invoice');
        const invoicePreviewModal = document.getElementById('invoice-preview-modal');
        const saveInvoiceBtn = document.getElementById('save-invoice');
        const saveAnimation = document.getElementById('save-animation');
        const paymentsReceivedEl = document.getElementById('payments-received');
        const pendingPaymentsEl = document.getElementById('pending-payments');
        const invoiceNumberInput = document.getElementById('invoice-number');
        const invoiceDetailsModal = document.getElementById('invoice-details-modal');
        const calendarMonthYear = document.getElementById('calendar-month-year');
        const calendarDays = document.getElementById('calendar-days');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const downloadInvoicePdfBtn = document.getElementById('download-invoice-pdf');
        const discountAmountInput = document.getElementById('discount-amount');
        const discountTypeSelect = document.getElementById('discount-type');
        const discountReasonInput = document.getElementById('discount-reason');
        
        // Variables for inline suggestions
        let currentSuggestion = '';
        let currentInput = null;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved data
            loadData();
            
            // Set current date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('invoice-date').value = today;
            document.getElementById('profit-month').value = today.substring(0, 7);
            
            // Generate a new invoice number
            invoiceNumberInput.value = generateInvoiceNumber();
            
            // Initialize inventory table
            renderInventoryTable();
            
            // Initialize profits table
            updateProfitsTable();
            
            // Initialize calendar
            renderCalendar();
            
            // Add event listeners
            setupEventListeners();
            
            // Calculate initial total
            calculateTotal();
        });
        
        function setupEventListeners() {
            // Navigation tabs - save data when switching tabs
            navTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Arrow key navigation between tabs
            document.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                    e.preventDefault();
                    navigateTabs(e.key);
                }
                
                // Close preview modal with Escape key
                if (e.key === 'Escape') {
                    invoicePreviewModal.style.display = 'none';
                }
            });
            
            // Add item to invoice
            addItemBtn.addEventListener('click', addInvoiceItem);
            
            // Remove item from invoice
            invoiceItemsTable.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-item')) {
                    const row = e.target.closest('tr');
                    if (invoiceItemsTable.querySelectorAll('tbody tr').length > 1) {
                        row.remove();
                        calculateTotal();
                    }
                }
            });
            
            // Update totals when quantity or item changes
            invoiceItemsTable.addEventListener('input', function(e) {
                if (e.target.classList.contains('item-qty') || e.target.classList.contains('item-description')) {
                    updateRowTotal(e.target.closest('tr'));
                    calculateTotal();
                }
            });
            
            // Inline suggestions for item descriptions
            invoiceItemsTable.addEventListener('input', function(e) {
                if (e.target.classList.contains('item-description')) {
                    handleItemDescriptionInput(e.target);
                }
            });
            
            // Tab key completion for inline suggestions
            invoiceItemsTable.addEventListener('keydown', function(e) {
                if (e.key === 'Tab' && e.target.classList.contains('item-description')) {
                    e.preventDefault();
                    completeWithSuggestion(e.target);
                }
                
                // Arrow down for next suggestion
                if (e.key === 'ArrowDown' && e.target.classList.contains('item-description')) {
                    e.preventDefault();
                    cycleSuggestion(e.target, 'next');
                }
                
                // Arrow up for previous suggestion
                if (e.key === 'ArrowUp' && e.target.classList.contains('item-description')) {
                    e.preventDefault();
                    cycleSuggestion(e.target, 'previous');
                }
            });
            
            // Discount input changes
            discountAmountInput.addEventListener('input', calculateTotal);
            discountTypeSelect.addEventListener('change', calculateTotal);
            
            // Add inventory item
            addInventoryItemBtn.addEventListener('click', () => {
                openInventoryModal();
            });
            
            // Close modals
            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    inventoryModal.style.display = 'none';
                    invoicePreviewModal.style.display = 'none';
                    invoiceDetailsModal.style.display = 'none';
                });
            });
            
            // Save inventory item
            inventoryForm.addEventListener('submit', saveInventoryItem);
            
            // Profit filters
            profitPeriod.addEventListener('change', updateProfitsTable);
            profitMonth.addEventListener('change', updateProfitsTable);
            
            // Preview invoice
            previewInvoiceBtn.addEventListener('click', previewInvoice);
            
            // Save invoice
            saveInvoiceBtn.addEventListener('click', saveInvoice);
            
            // Add advance payment
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('add-advance')) {
                    const invoiceId = e.target.getAttribute('data-id');
                    addAdvancePayment(invoiceId);
                }
                
                if (e.target.classList.contains('save-payment')) {
                    const invoiceId = e.target.getAttribute('data-id');
                    savePaymentStatus(invoiceId);
                }
                
                if (e.target.classList.contains('remove-project')) {
                    const invoiceId = e.target.getAttribute('data-id');
                    removeProject(invoiceId);
                }
            });
            
            // View invoice details on double click
            projectProfitsTable.addEventListener('dblclick', function(e) {
                const row = e.target.closest('tr');
                if (row && row.getAttribute('data-id')) {
                    const invoiceId = row.getAttribute('data-id');
                    viewInvoiceDetails(invoiceId);
                }
            });
            
            // Calendar navigation
            prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });
            
            nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });
            
            // Save data when leaving the page
            window.addEventListener('beforeunload', saveData);
            
            // Download invoice as PDF
            downloadInvoicePdfBtn.addEventListener('click', downloadInvoiceAsPDF);
        }
        
        function handleItemDescriptionInput(input) {
            const value = input.value.toLowerCase();
            const suggestionElement = input.parentNode.querySelector('.inline-suggestion');
            
            if (value.length < 1) {
                suggestionElement.textContent = '';
                currentSuggestion = '';
                currentInput = null;
                return;
            }
            
            // Find matching items
            const matchingItems = inventory.filter(item => 
                item.description.toLowerCase().includes(value)
            );
            
            if (matchingItems.length > 0) {
                // Show the first matching item as suggestion
                const suggestion = matchingItems[0].description;
                currentSuggestion = suggestion;
                currentInput = input;
                
                // Display the suggestion
                suggestionElement.textContent = value + suggestion.substring(value.length);
            } else {
                suggestionElement.textContent = '';
                currentSuggestion = '';
                currentInput = null;
            }
        }
        
        function cycleSuggestion(input, direction) {
            const value = input.value.toLowerCase();
            const matchingItems = inventory.filter(item => 
                item.description.toLowerCase().includes(value)
            );
            
            if (matchingItems.length === 0) return;
            
            const suggestionElement = input.parentNode.querySelector('.inline-suggestion');
            let currentIndex = matchingItems.findIndex(item => item.description === currentSuggestion);
            
            if (direction === 'next') {
                currentIndex = (currentIndex + 1) % matchingItems.length;
            } else if (direction === 'previous') {
                currentIndex = (currentIndex - 1 + matchingItems.length) % matchingItems.length;
            }
            
            currentSuggestion = matchingItems[currentIndex].description;
            suggestionElement.textContent = value + currentSuggestion.substring(value.length);
        }
        
        function completeWithSuggestion(input) {
            if (currentSuggestion && currentInput === input) {
                input.value = currentSuggestion;
                const suggestionElement = input.parentNode.querySelector('.inline-suggestion');
                suggestionElement.textContent = '';
                currentSuggestion = '';
                currentInput = null;
                updateRowTotal(input.closest('tr'));
                calculateTotal();
                
                // Move to next field
                const nextInput = input.closest('tr').querySelector('.item-qty');
                if (nextInput) {
                    nextInput.focus();
                    nextInput.select();
                }
            }
        }
        
        function navigateTabs(direction) {
            const currentTab = document.querySelector('.nav-tab.active');
            let nextTab;
            
            if (direction === 'ArrowRight') {
                nextTab = currentTab.nextElementSibling || navTabs[0];
            } else if (direction === 'ArrowLeft') {
                nextTab = currentTab.previousElementSibling || navTabs[navTabs.length - 1];
            }
            
            if (nextTab) {
                const tabId = nextTab.getAttribute('data-tab');
                switchTab(tabId);
            }
        }
        
        function switchTab(tabId) {
            // Update active tab
            navTabs.forEach(t => t.classList.remove('active'));
            document.querySelector(`.nav-tab[data-tab="${tabId}"]`).classList.add('active');
            
            // Show corresponding content
            tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === tabId) {
                    content.classList.add('active');
                }
            });
            
            // Save data when switching tabs
            saveData();
            
            // If calendar tab is active, refresh it
            if (tabId === 'calendar') {
                renderCalendar();
            }
        }
        
        function addInvoiceItem() {
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>
                    <div class="description-container">
                        <input type="text" class="item-description" placeholder="Item description">
                        <div class="inline-suggestion"></div>
                    </div>
                </td>
                <td><input type="number" class="item-qty" min="1" value="1"></td>
                <td><input type="number" class="item-price" readonly></td>
                <td class="item-total">LKR 0</td>
                <td><button class="btn-danger remove-item">×</button></td>
            `;
            invoiceItemsTable.querySelector('tbody').appendChild(newRow);
        }
        
        function updateRowTotal(row) {
            const qty = parseInt(row.querySelector('.item-qty').value) || 0;
            const description = row.querySelector('.item-description').value;
            
            // Find the item in inventory to get the price
            const item = inventory.find(i => i.description === description);
            const price = item ? item.sellingPrice : 0;
            
            row.querySelector('.item-price').value = price;
            const total = qty * price;
            row.querySelector('.item-total').textContent = `LKR ${total.toLocaleString()}`;
        }
        
        function calculateTotal() {
            let subtotal = 0;
            const rows = invoiceItemsTable.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const totalText = row.querySelector('.item-total').textContent;
                const amount = parseFloat(totalText.replace('LKR ', '').replace(/,/g, '')) || 0;
                subtotal += amount;
            });
            
            // Calculate discount
            const discountAmount = parseFloat(discountAmountInput.value) || 0;
            const discountType = discountTypeSelect.value;
            let discount = 0;
            let total = subtotal;
            
            if (discountAmount > 0) {
                if (discountType === 'percentage') {
                    discount = (subtotal * discountAmount) / 100;
                    discountValueEl.textContent = `${discountAmount}% (LKR ${discount.toLocaleString()})`;
                } else {
                    discount = Math.min(discountAmount, subtotal);
                    discountValueEl.textContent = `LKR ${discount.toLocaleString()}`;
                }
                total = subtotal - discount;
                discountDisplayEl.style.display = 'flex';
            } else {
                discountDisplayEl.style.display = 'none';
            }
            
            subtotalEl.textContent = `LKR ${subtotal.toLocaleString()}`;
            grandTotalEl.textContent = `LKR ${total.toLocaleString()}`;
        }
        
        function renderInventoryTable() {
            const tbody = inventoryTable.querySelector('tbody');
            tbody.innerHTML = '';
            
            inventory.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.description}</td>
                    <td>LKR ${item.buyingPrice.toLocaleString()}</td>
                    <td>LKR ${item.sellingPrice.toLocaleString()}</td>
                    <td>
                        <button class="btn-primary edit-item" data-id="${item.id}">Edit</button>
                        <button class="btn-danger delete-item" data-id="${item.id}">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.edit-item').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = parseInt(btn.getAttribute('data-id'));
                    openInventoryModal(id);
                });
            });
            
            document.querySelectorAll('.delete-item').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = parseInt(btn.getAttribute('data-id'));
                    deleteInventoryItem(id);
                });
            });
        }
        
        function openInventoryModal(id = null) {
            const modalTitle = document.getElementById('modal-title');
            const form = document.getElementById('inventory-form');
            
            if (id) {
                // Edit mode
                modalTitle.textContent = 'Edit Inventory Item';
                const item = inventory.find(i => i.id === id);
                document.getElementById('item-id').value = item.id;
                document.getElementById('item-description').value = item.description;
                document.getElementById('item-buying-price').value = item.buyingPrice;
                document.getElementById('item-selling-price').value = item.sellingPrice;
            } else {
                // Add mode
                modalTitle.textContent = 'Add Inventory Item';
                form.reset();
                document.getElementById('item-id').value = '';
            }
            
            inventoryModal.style.display = 'flex';
        }
        
        function saveInventoryItem(e) {
            e.preventDefault();
            
            const id = document.getElementById('item-id').value;
            const description = document.getElementById('item-description').value;
            const buyingPrice = parseFloat(document.getElementById('item-buying-price').value);
            const sellingPrice = parseFloat(document.getElementById('item-selling-price').value);
            
            if (id) {
                // Update existing item
                const index = inventory.findIndex(item => item.id == id);
                inventory[index] = { id: parseInt(id), description, buyingPrice, sellingPrice };
            } else {
                // Add new item
                const newId = inventory.length > 0 ? Math.max(...inventory.map(i => i.id)) + 1 : 1;
                inventory.push({ id: newId, description, buyingPrice, sellingPrice });
            }
            
            renderInventoryTable();
            inventoryModal.style.display = 'none';
            saveData();
        }
        
        function deleteInventoryItem(id) {
            if (confirm('Are you sure you want to delete this item?')) {
                inventory = inventory.filter(item => item.id !== id);
                renderInventoryTable();
                saveData();
            }
        }
        
        function updateProfitsTable() {
            const period = profitPeriod.value;
            const month = profitMonth.value;
            
            // Filter invoices based on period
            let filteredInvoices = [...invoices];
            
            if (period === 'monthly') {
                filteredInvoices = invoices.filter(invoice => {
                    const invoiceMonth = invoice.date.substring(0, 7); // YYYY-MM
                    return invoiceMonth === month;
                });
            }
            
            // Calculate overall profit and payments
            let overallProfit = 0;
            let paymentsReceived = 0;
            let pendingPayments = 0;
            
            filteredInvoices.forEach(invoice => {
                let revenue = invoice.total;
                let cost = 0;
                
                // Calculate cost based on inventory items
                invoice.items.forEach(item => {
                    const inventoryItem = inventory.find(i => i.description === item.description);
                    if (inventoryItem) {
                        cost += item.qty * inventoryItem.buyingPrice;
                    }
                });
                
                const profit = revenue - cost;
                const advancePayment = invoice.advancePayment || 0;
                const pendingPayment = invoice.status === 'paid' ? 0 : (revenue - advancePayment);
                
                overallProfit += profit;
                paymentsReceived += invoice.status === 'paid' ? revenue : advancePayment;
                pendingPayments += pendingPayment;
            });
            
            overallProfitEl.textContent = `LKR ${overallProfit.toLocaleString()}`;
            paymentsReceivedEl.textContent = `LKR ${paymentsReceived.toLocaleString()}`;
            pendingPaymentsEl.textContent = `LKR ${pendingPayments.toLocaleString()}`;
            
            // Update project profits table - INVERTED SORT (most recent first)
            const tbody = projectProfitsTable.querySelector('tbody');
            tbody.innerHTML = '';
            
            // Sort invoices by ID in descending order (most recent first)
            const sortedInvoices = [...filteredInvoices].sort((a, b) => {
                return b.id - a.id; // Sort by invoice ID descending
            });
            
            sortedInvoices.forEach(invoice => {
                let revenue = invoice.total;
                let cost = 0;
                
                // Calculate cost based on inventory items
                invoice.items.forEach(item => {
                    const inventoryItem = inventory.find(i => i.description === item.description);
                    if (inventoryItem) {
                        cost += item.qty * inventoryItem.buyingPrice;
                    }
                });
                
                const profit = revenue - cost;
                const advancePayment = invoice.advancePayment || 0;
                const pendingPayment = invoice.status === 'paid' ? 0 : (revenue - advancePayment);
                const status = invoice.status === 'paid' ? 'paid' : (pendingPayment > 0 ? 'pending' : 'paid');
                
                const row = document.createElement('tr');
                row.className = 'project-row';
                row.setAttribute('data-id', invoice.id);
                row.innerHTML = `
                    <td>${invoice.project}</td>
                    <td>LKR ${revenue.toLocaleString()}</td>
                    <td>LKR ${cost.toLocaleString()}</td>
                    <td>LKR ${profit.toLocaleString()}</td>
                    <td>LKR ${advancePayment.toLocaleString()}</td>
                    <td>LKR ${pendingPayment.toLocaleString()}</td>
                    <td>
                        <div class="project-actions">
                            ${invoice.advancePayment === undefined || invoice.advancePayment === 0 ? `
                            <div class="payment-controls">
                                <input type="number" class="payment-input" id="advance-${invoice.id}" placeholder="Advance amount">
                                <button class="btn-primary btn-small add-advance" data-id="${invoice.id}">Add</button>
                            </div>
                            ` : ''}
                            <div class="full-payment">
                                <input type="checkbox" id="paid-${invoice.id}" class="mark-paid" data-id="${invoice.id}" ${invoice.status === 'paid' ? 'checked' : ''}>
                                <label for="paid-${invoice.id}">Full payment done</label>
                            </div>
                            <button class="btn-success btn-small save-payment" data-id="${invoice.id}">Save Payment</button>
                            <button class="btn-danger btn-small remove-project" data-id="${invoice.id}">Remove Project</button>
                        </div>
                    </td>
                    <td><span class="payment-status ${status}">${status}</span></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function addAdvancePayment(invoiceId) {
            const amountInput = document.getElementById(`advance-${invoiceId}`);
            const amount = parseFloat(amountInput.value);
            
            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            const invoiceIndex = invoices.findIndex(inv => inv.id == invoiceId);
            if (invoiceIndex !== -1) {
                invoices[invoiceIndex].advancePayment = amount;
                amountInput.value = '';
                updateProfitsTable();
                saveData();
                
                // Show save animation
                saveAnimation.textContent = 'Advance Payment Added!';
                saveAnimation.style.display = 'block';
                setTimeout(() => {
                    saveAnimation.style.display = 'none';
                }, 1000);
            }
        }
        
        function savePaymentStatus(invoiceId) {
            const invoiceIndex = invoices.findIndex(inv => inv.id == invoiceId);
            if (invoiceIndex !== -1) {
                const isPaid = document.getElementById(`paid-${invoiceId}`).checked;
                invoices[invoiceIndex].status = isPaid ? 'paid' : 'pending';
                updateProfitsTable();
                saveData();
                
                // Show save animation
                saveAnimation.textContent = 'Payment Status Saved!';
                saveAnimation.style.display = 'block';
                setTimeout(() => {
                    saveAnimation.style.display = 'none';
                }, 1000);
            }
        }
        
        function removeProject(invoiceId) {
            if (confirm('Are you sure you want to remove this project?')) {
                invoices = invoices.filter(inv => inv.id != invoiceId);
                updateProfitsTable();
                saveData();
                
                // Show save animation
                saveAnimation.textContent = 'Project Removed!';
                saveAnimation.style.display = 'block';
                setTimeout(() => {
                    saveAnimation.style.display = 'none';
                }, 1000);
            }
        }
        
        function viewInvoiceDetails(invoiceId) {
            const invoice = invoices.find(inv => inv.id == invoiceId);
            if (!invoice) return;
            
            const invoiceDetails = document.getElementById('invoice-details');
            
            let itemsHtml = '';
            invoice.items.forEach(item => {
                itemsHtml += `
                    <tr>
                        <td>${item.description}</td>
                        <td>${item.qty}</td>
                        <td>LKR ${item.price.toLocaleString()}</td>
                        <td>LKR ${item.total.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            invoiceDetails.innerHTML = `
                <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: white; color: black;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img src="Invoice.jpg" alt="Dexter Projects LK" style="width: 100%; max-width: 800px; border-radius: 12px;" onerror="this.style.display='none'">
                    </div>
                    <p style="text-align: center; margin-bottom: 20px;"><strong>CONTACT: 0775980665</strong></p>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                        <div>
                            <p><strong>Date:</strong> ${formatDate(invoice.date)}</p>
                        </div>
                        <div>
                            <p><strong>Invoice No:</strong> ${invoice.id}</p>
                        </div>
                    </div>
                    
                    <hr style="border: none; border-top: 1px solid #000; margin: 20px 0;">
                    
                    <div style="margin-bottom: 20px;">
                        <h2>INVOICE TO:</h2>
                        <p>${invoice.invoiceTo}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h2>Project:</h2>
                        <p>${invoice.project}</p>
                    </div>
                    
                    ${invoice.deadline ? `
                    <div style="margin-bottom: 20px;">
                        <h2>Deadline:</h2>
                        <p>${formatDate(invoice.deadline)}</p>
                    </div>
                    ` : ''}
                    
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 10px; border-bottom: 1px solid #000;">Description</th>
                                <th style="text-align: left; padding: 10px; border-bottom: 1px solid #000;">Qty</th>
                                <th style="text-align: left; padding: 10px; border-bottom: 1px solid #000;">Price</th>
                                <th style="text-align: left; padding: 10px; border-bottom: 1px solid #000;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>
                    
                    <hr style="border: none; border-top: 1px solid #000; margin: 20px 0;">
                    
                    <div style="text-align: right; font-size: 1.2em; font-weight: bold; margin-top: 20px;">
                        <p>Total: LKR ${invoice.total.toLocaleString()}</p>
                    </div>
                    
                    ${invoice.notes ? `
                    <div style="margin-top: 30px;">
                        <p><strong>Notes:</strong> ${invoice.notes}</p>
                    </div>
                    ` : ''}
                    
                    ${invoice.discountAmount ? `
                    <div style="margin-top: 30px;">
                        <p><strong>Discount:</strong> ${invoice.discountType === 'percentage' ? `${invoice.discountAmount}%` : `LKR ${invoice.discountAmount.toLocaleString()}`}</p>
                        ${invoice.discountReason ? `<p><strong>Discount Reason:</strong> ${invoice.discountReason}</p>` : ''}
                    </div>
                    ` : ''}
                    
                    <div style="margin-top: 30px;">
                        <p><strong>Payment Status:</strong> ${invoice.status === 'paid' ? 'Paid' : 'Pending'}</p>
                        ${invoice.advancePayment ? `<p><strong>Advance Payment:</strong> LKR ${invoice.advancePayment.toLocaleString()}</p>` : ''}
                    </div>
                </div>
            `;
            
            // Store the current invoice ID for PDF download
            downloadInvoicePdfBtn.setAttribute('data-invoice-id', invoiceId);
            
            invoiceDetailsModal.style.display = 'flex';
        }
        
        function previewInvoice() {
            const invoicePreview = document.getElementById('invoice-preview');
            const date = document.getElementById('invoice-date').value;
            const invoiceNumber = document.getElementById('invoice-number').value;
            const invoiceTo = document.getElementById('invoice-to').value;
            const projectName = document.getElementById('project-name').value;
            const deadline = document.getElementById('deadline').value;
            const notes = document.getElementById('invoice-notes').value;
            const discountAmount = parseFloat(discountAmountInput.value) || 0;
            const discountType = discountTypeSelect.value;
            const discountReason = discountReasonInput.value;
            
            // Format date
            const formattedDate = formatDate(date);
            
            // Generate invoice preview HTML
            let itemsHtml = '';
            const rows = invoiceItemsTable.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const description = row.querySelector('.item-description').value;
                const qty = row.querySelector('.item-qty').value;
                const price = row.querySelector('.item-price').value;
                const total = row.querySelector('.item-total').textContent;
                
                if (description) {
                    itemsHtml += `
                        <tr>
                            <td>${description}</td>
                            <td>${qty}</td>
                            <td>LKR ${parseInt(price).toLocaleString()}</td>
                            <td>${total}</td>
                        </tr>
                    `;
                }
            });
            
            // Calculate discount for display
            let subtotal = parseFloat(subtotalEl.textContent.replace('LKR ', '').replace(/,/g, '')) || 0;
            let discount = 0;
            let total = subtotal;
            
            if (discountAmount > 0) {
                if (discountType === 'percentage') {
                    discount = (subtotal * discountAmount) / 100;
                } else {
                    discount = Math.min(discountAmount, subtotal);
                }
                total = subtotal - discount;
            }
            
            invoicePreview.innerHTML = `
                <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: white; color: black;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img src="Invoice.jpg" alt="Dexter Projects LK" style="width: 100%; max-width: 800px; border-radius: 12px;" onerror="this.style.display='none'">
                    </div>
                    <p style="text-align: center; margin-bottom: 20px;"><strong>CONTACT: 0775980665</strong></p>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                        <div>
                            <p><strong>Date:</strong> ${formattedDate}</p>
                        </div>
                        <div>
                            <p><strong>Invoice No:</strong> ${invoiceNumber}</p>
                        </div>
                    </div>
                    
                    <hr style="border: none; border-top: 1px solid #000; margin: 20px 0;">
                    
                    <div style="margin-bottom: 20px;">
                        <h2>INVOICE TO:</h2>
                        <p>${invoiceTo}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h2>Project:</h2>
                        <p>${projectName}</p>
                    </div>
                    
                    ${deadline ? `
                    <div style="margin-bottom: 20px;">
                        <h2>Deadline:</h2>
                        <p>${formatDate(deadline)}</p>
                    </div>
                    ` : ''}
                    
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 10px; border-bottom: 1px solid #000;">Description</th>
                                <th style="text-align: left; padding: 10px; border-bottom: 1px solid #000;">Qty</th>
                                <th style="text-align: left; padding: 10px; border-bottom: 1px solid #000;">Price</th>
                                <th style="text-align: left; padding: 10px; border-bottom: 1px solid #000;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>
                    
                    <hr style="border: none; border-top: 1px solid #000; margin: 20px 0;">
                    
                    <div style="text-align: right; font-size: 1.2em; font-weight: bold; margin-top: 20px;">
                        <p>Subtotal: LKR ${subtotal.toLocaleString()}</p>
                        ${discount > 0 ? `
                        <p style="color: #dc3545;">Discount: ${discountType === 'percentage' ? `${discountAmount}%` : ''} LKR ${discount.toLocaleString()}</p>
                        ${discountReason ? `<p><small>Discount Reason: ${discountReason}</small></p>` : ''}
                        ` : ''}
                        <p style="margin-top: 10px; font-size: 1.3em;">Total: LKR ${total.toLocaleString()}</p>
                    </div>
                    
                    ${notes ? `
                    <div style="margin-top: 30px;">
                        <p><strong>Notes:</strong> ${notes}</p>
                    </div>
                    ` : ''}
                </div>
            `;
            
            invoicePreviewModal.style.display = 'flex';
        }
        
        function downloadInvoiceAsPDF() {
            const invoiceId = downloadInvoicePdfBtn.getAttribute('data-invoice-id');
            const invoice = invoices.find(inv => inv.id == invoiceId);
            
            if (!invoice) return;
            
            // Create a new window for printing
            const printWindow = window.open('', '_blank');
            
            let itemsHtml = '';
            invoice.items.forEach(item => {
                itemsHtml += `
                    <tr>
                        <td>${item.description}</td>
                        <td>${item.qty}</td>
                        <td>LKR ${item.price.toLocaleString()}</td>
                        <td>LKR ${item.total.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            let discountHtml = '';
            if (invoice.discountAmount) {
                discountHtml = `
                    <p style="color: #dc3545;"><strong>Discount:</strong> ${invoice.discountType === 'percentage' ? `${invoice.discountAmount}%` : `LKR ${invoice.discountAmount.toLocaleString()}`}</p>
                    ${invoice.discountReason ? `<p><strong>Discount Reason:</strong> ${invoice.discountReason}</p>` : ''}
                `;
            }
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Invoice ${invoice.id}</title>
                    <style>
                        @media print {
                            @page {
                                margin: 0;
                                size: A4;
                            }
                            body {
                                margin: 1.5cm;
                                font-family: Arial, sans-serif;
                                color: black;
                            }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            max-width: 800px;
                            margin: 0 auto;
                            padding: 20px;
                            color: black;
                        }
                        img {
                            width: 100%;
                            max-width: 800px;
                            border-radius: 12px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 20px 0;
                        }
                        th, td {
                            padding: 10px;
                            text-align: left;
                            border-bottom: 1px solid #000;
                        }
                        hr {
                            border: none;
                            border-top: 1px solid #000;
                            margin: 20px 0;
                        }
                    </style>
                </head>
                <body onload="window.print(); window.close();">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img src="Invoice.jpg" alt="Dexter Projects LK" onerror="this.style.display='none'">
                    </div>
                    <p style="text-align: center; margin-bottom: 20px;"><strong>CONTACT: 0775980665</strong></p>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                        <div>
                            <p><strong>Date:</strong> ${formatDate(invoice.date)}</p>
                        </div>
                        <div>
                            <p><strong>Invoice No:</strong> ${invoice.id}</p>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div style="margin-bottom: 20px;">
                        <h2>INVOICE TO:</h2>
                        <p>${invoice.invoiceTo}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h2>Project:</h2>
                        <p>${invoice.project}</p>
                    </div>
                    
                    ${invoice.deadline ? `
                    <div style="margin-bottom: 20px;">
                        <h2>Deadline:</h2>
                        <p>${formatDate(invoice.deadline)}</p>
                    </div>
                    ` : ''}
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Qty</th>
                                <th>Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>
                    
                    <hr>
                    
                    <div style="text-align: right; font-size: 1.2em; font-weight: bold; margin-top: 20px;">
                        <p>Total: LKR ${invoice.total.toLocaleString()}</p>
                        ${discountHtml}
                    </div>
                    
                    ${invoice.notes ? `
                    <div style="margin-top: 30px;">
                        <p><strong>Notes:</strong> ${invoice.notes}</p>
                    </div>
                    ` : ''}
                    
                    <div style="margin-top: 30px;">
                        <p><strong>Payment Status:</strong> ${invoice.status === 'paid' ? 'Paid' : 'Pending'}</p>
                        ${invoice.advancePayment ? `<p><strong>Advance Payment:</strong> LKR ${invoice.advancePayment.toLocaleString()}</p>` : ''}
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
        }
        
        function saveInvoice() {
            const date = document.getElementById('invoice-date').value;
            const invoiceNumber = document.getElementById('invoice-number').value;
            const invoiceTo = document.getElementById('invoice-to').value;
            const projectName = document.getElementById('project-name').value;
            const deadline = document.getElementById('deadline').value;
            const notes = document.getElementById('invoice-notes').value;
            const discountAmount = parseFloat(discountAmountInput.value) || 0;
            const discountType = discountTypeSelect.value;
            const discountReason = discountReasonInput.value;
            const total = parseFloat(grandTotalEl.textContent.replace('LKR ', '').replace(/,/g, ''));
            const subtotal = parseFloat(subtotalEl.textContent.replace('LKR ', '').replace(/,/g, '')) || 0;
            
            // Collect items
            const items = [];
            const rows = invoiceItemsTable.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const description = row.querySelector('.item-description').value;
                const qty = parseInt(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                
                if (description && qty > 0) {
                    items.push({
                        description,
                        qty,
                        price,
                        total: qty * price
                    });
                }
            });
            
            // Check if we're editing an existing invoice or creating a new one
            const existingInvoiceIndex = invoices.findIndex(inv => inv.id == invoiceNumber);
            
            if (existingInvoiceIndex !== -1) {
                // Update existing invoice
                invoices[existingInvoiceIndex] = {
                    id: parseInt(invoiceNumber),
                    date,
                    invoiceTo,
                    project: projectName,
                    deadline,
                    items,
                    notes,
                    subtotal,
                    discountAmount,
                    discountType,
                    discountReason,
                    total,
                    advancePayment: invoices[existingInvoiceIndex].advancePayment || 0,
                    status: invoices[existingInvoiceIndex].status
                };
            } else {
                // Create new invoice
                invoices.push({
                    id: parseInt(invoiceNumber),
                    date,
                    invoiceTo,
                    project: projectName,
                    deadline,
                    items,
                    notes,
                    subtotal,
                    discountAmount,
                    discountType,
                    discountReason,
                    total,
                    advancePayment: 0,
                    status: 'pending'
                });
                
                // Generate new invoice number for next invoice
                invoiceNumberInput.value = generateInvoiceNumber();
            }
            
            // Save data
            saveData();
            
            // Show save animation
            saveAnimation.textContent = 'Invoice Saved Successfully!';
            saveAnimation.style.display = 'block';
            setTimeout(() => {
                saveAnimation.style.display = 'none';
            }, 1000);
            
            // Update all tabs with new data
            updateAllTabs();
            
            // Clear form for new invoice
            document.getElementById('invoice-to').value = '';
            document.getElementById('project-name').value = '';
            document.getElementById('deadline').value = '';
            document.getElementById('invoice-notes').value = '';
            discountAmountInput.value = '';
            discountReasonInput.value = '';
            
            // Clear items table except first row
            const tbody = invoiceItemsTable.querySelector('tbody');
            while (tbody.children.length > 1) {
                tbody.removeChild(tbody.lastChild);
            }
            
            // Reset first row
            const firstRow = tbody.children[0];
            firstRow.querySelector('.item-description').value = '';
            firstRow.querySelector('.item-qty').value = '1';
            firstRow.querySelector('.item-price').value = '';
            firstRow.querySelector('.item-total').textContent = 'LKR 0';
            
            // Reset totals
            calculateTotal();
        }
        
        function updateAllTabs() {
            // Update profits table
            updateProfitsTable();
            
            // Update calendar if it's active
            if (document.getElementById('calendar').classList.contains('active')) {
                renderCalendar();
            }
        }
        
        function generateInvoiceNumber() {
            // Simple invoice number generation - in a real app, this would be more sophisticated
            const maxId = invoices.length > 0 ? Math.max(...invoices.map(i => i.id)) : 0;
            return maxId + 1;
        }
        
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            return date.toLocaleDateString('en-GB', options);
        }
        
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const today = new Date();
            
            // Update calendar header
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];
            calendarMonthYear.textContent = `${monthNames[month]} ${year}`;
            
            // Clear calendar
            calendarDays.innerHTML = '';
            
            // Add day headers
            const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
            dayNames.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day-header';
                dayElement.textContent = day;
                calendarDays.appendChild(dayElement);
            });
            
            // Get first day of month and number of days in month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < firstDay.getDay(); i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                calendarDays.appendChild(dayElement);
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const currentDay = new Date(year, month, day);
                
                // Check if this is today
                if (currentDay.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }
                
                // Check if this day has any deadlines
                const deadlines = invoices.filter(invoice => invoice.deadline === dateStr);
                
                if (deadlines.length > 0) {
                    // Calculate days until deadline
                    const daysUntilDeadline = Math.ceil((currentDay - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysUntilDeadline <= 3 && daysUntilDeadline >= 0) {
                        dayElement.classList.add('urgent-deadline');
                    } else if (daysUntilDeadline > 3) {
                        dayElement.classList.add('normal-deadline');
                    }
                    
                    deadlines.forEach(invoice => {
                        const deadlineItem = document.createElement('div');
                        deadlineItem.className = 'deadline-item';
                        deadlineItem.textContent = invoice.project;
                        dayElement.appendChild(deadlineItem);
                    });
                }
                
                const dayNumber = document.createElement('div');
                dayNumber.textContent = day;
                dayElement.appendChild(dayNumber);
                
                calendarDays.appendChild(dayElement);
            }
        }
    </script>
</body>
</html>
